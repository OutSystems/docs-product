name: Validate Visual Assets

on:
  workflow_call:
    inputs:
      files:
        description: "List of files to validate"
        type: string
        required: true
    outputs:
      report:
        description: "Mardown report containing changes"
        value: ${{ jobs.check.outputs.report }}

concurrency: visual-assets-${{ github.ref }}

run-name: "Validate visual assets in ${{ github.ref_name }}"


jobs:
  check:
    name: "Validate"

    runs-on: ubuntu-latest
      
    steps:
    - name: Count files
      id: count
      run:
        echo "number=$(echo "${{ inputs.files }}" | grep -v "^translated" | grep -v "^.github" | wc -l)" >> $GITHUB_OUTPUT

    - name: Trim paths
      if: steps.count.outputs.number > 0
      id: paths
      run: |
       echo "files<<EOF" >> $GITHUB_OUTPUT
       echo "${{ inputs.files }}" | grep -v "^translated" | grep -v "^.github" >> $GITHUB_OUTPUT
       echo "EOF" >> $GITHUB_OUTPUT

    - name: Checkout
      if: inputs.files == '' || steps.count.outputs.number > 0
      uses: actions/checkout@v6
      with:
        fetch-depth: 1
        ref: ${{ github.event.pull_request.head.ref || github.ref_name }}

    - name: 'Download markdown-figma'
      if: inputs.files == '' || steps.count.outputs.number > 0
      uses: MiguelDomingues/markdown-figma-action@v1.05

    - name: 'Validate visual assets for changed files'
      if: steps.count.outputs.number > 0
      run: |
        VALID_SUFFIXES="-(ss|odcs|is|lt|sc|pl|usr|at|ct|af|gc|fg|ams|ib|eb|we|az|vs|ok|fc|diag)$"
        while IFS= read -r file; do
          [ -z "$file" ] && continue

          if [ ! -f "${file}" ]; then
            echo "${file} does not exist."
            continue
          fi

          # Validate image files
          if [[ "$file" =~ \.(png|jpg|jpeg|gif|webp|svg)$ ]]; then
            filename=$(basename "$file")
            name_without_ext="${filename%.*}"
            HAS_ERRORS=0

            # Only .png extension allowed
            if [[ ! "$filename" =~ \.png$ ]]; then
              echo "- ❌ $file: Image must have .png extension (only .png is allowed, got: ${filename##*.})" >> report.md
              HAS_ERRORS=1
            fi

            # Hyphen-separated, lowercase letters, numbers and hyphens only, no special characters
            if [[ ! "$name_without_ext" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
              echo "- ❌ $file: Image name must be hyphen-separated, lowercase letters, numbers and hyphens only (no special characters)" >> report.md
              HAS_ERRORS=1
            fi

            # Must end with one of the valid suffixes
            if [[ ! "$name_without_ext" =~ $VALID_SUFFIXES ]]; then
              echo "- ❌ $file: Image name must end with one of: ss, odcs, is, lt, sc, pl, usr, at, ct, af, gc, fg, ams, ib, eb, we, az, vs, ok, fc, diag. See [Image file names](https://outsystemsrd.atlassian.net/wiki/spaces/TK/pages/3179839882/Screenshots#Image-file-names) for reference." >> report.md
              HAS_ERRORS=1
            fi

            if [ $HAS_ERRORS -eq 0 ]; then
              echo "✅ $file: Image naming valid"
            fi
          elif [[ "$file" =~ \.md$ ]]; then
            # Validate .md files with image links have figma in frontmatter
            if grep -qE '!\[.*\]\([^)]*\.(png|svg)' "${file}"; then
              figma=$(awk '/^---$/{f=!f;next} f && /^figma:/{sub(/^figma:[[:space:]]*/,""); print; exit}' "${file}")
              if [[ -z "$figma" || ! "$figma" =~ ^https?:// ]]; then
                echo "- ❌ $file: Markdown contains image links but frontmatter is missing a figma property with a valid URL." >> report.md
              fi
            fi
            # Run markdown-figma on markdown files
            echo "Run markdown-figma on ${file}.";
            markdown-figma --input "${file}" --api-token ${{ secrets.FIGMA_API_TOKEN }} --export "images" --similarity ${{ vars.FIGMA_SIMILARITY_THRESHOLD }} --svg-visual-check-only --report report.md --report-append --parse-html;
          else
            echo "Skipping ${file} (not an image or markdown file)."
          fi
        done << EOF
        ${{ steps.paths.outputs.files }}
        EOF

    - name: Check if report exists
      if: inputs.files == '' || steps.count.outputs.number > 0
      id: check_files
      uses: andstor/file-existence-action@v3
      with:
        files: 'report.md'

    - name: Read report.md
      if: steps.check_files.outcome == 'success' && steps.check_files.outputs.files_exists == 'true'
      id: get-report
      uses: juliangruber/read-file-action@v1
      with:
        path: ./report.md
        trim: true
        
    - name: 'Generate Report'
      if: steps.check_files.outcome == 'success' && steps.check_files.outputs.files_exists == 'true' && steps.get-report.outputs.content != ''
      id: generate-report
      run: |
        delimiter="$(openssl rand -hex 8)"
        echo "body<<$delimiter" >> $GITHUB_OUTPUT
        cat .github/visual-assets-pr-intro.md >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "${{ steps.get-report.outputs.content }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        cat .github/visual-assets-pr-outro.md >> $GITHUB_OUTPUT
        echo "$delimiter" >> $GITHUB_OUTPUT
      
    - name: 'Visual assets validation failed'
      if: steps.check_files.outcome == 'success' && steps.check_files.outputs.files_exists == 'true' && steps.get-report.outputs.content != ''
      uses: actions/github-script@v8
      with:
        script: |
            core.setFailed('Validation of visual assets failed.');
  
    outputs:
      report: ${{ steps.generate-report.outputs.body || ''}}
